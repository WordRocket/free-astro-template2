---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/sections/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/sections/Header.astro';
import PostMeta from '../components/ui/meta/PostMeta.astro';
import ShareButtons from '../components/ui/share/ShareButtons.astro';
import PostNav from '../components/ui/nav/PostNav.astro';

type BlogData = CollectionEntry<'blog'>['data'];
type Props = BlogData & { showHeader?: boolean; prevPost?: { id: string; title: string } | null; nextPost?: { id: string; title: string } | null; readingTimeMin?: number };

const { title, description, pubDate, updatedDate, heroImage, showHeader = true, prevPost = null, nextPost = null, readingTimeMin = 0 } = Astro.props as Props;
---

<html lang="en" data-theme="dark" class="dark">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
		<meta property="og:type" content="article" />
		<!-- Article specific OG meta -->
		{pubDate && <meta property="article:published_time" content={new Date(pubDate).toISOString()} />}
		{updatedDate && <meta property="article:modified_time" content={new Date(updatedDate).toISOString()} />}
		<meta property="article:author" content={Astro.props.author || 'Site Author'} />
		{Array.isArray(Astro.props.tags) && Astro.props.tags.map((t) => (
		  <meta property="article:tag" content={t} />
		))}

		<!-- JSON-LD: Article -->
		<script type="application/ld+json" set:html={JSON.stringify({
		  '@context': 'https://schema.org',
		  '@type': 'Article',
		  headline: title,
		  description,
		  image: Astro.props.heroImage ? new URL(Astro.props.heroImage.src, Astro.site).toString() : undefined,
		  datePublished: pubDate ? new Date(pubDate).toISOString() : undefined,
		  dateModified: updatedDate ? new Date(updatedDate).toISOString() : undefined,
		  author: [{ '@type': 'Person', name: Astro.props.author || 'Site Author' }],
		  publisher: { '@type': 'Organization', name: 'guihubie.com' },
		  mainEntityOfPage: new URL(Astro.url.pathname, Astro.site).toString(),
		  url: new URL(Astro.url.pathname, Astro.site).toString(),
		})} />

		<!-- JSON-LD: Breadcrumbs -->
		<script type="application/ld+json" set:html={JSON.stringify({
		  '@context': 'https://schema.org',
		  '@type': 'BreadcrumbList',
		  itemListElement: [
		    { '@type': 'ListItem', position: 1, name: 'Home', item: new URL('/', Astro.site).toString() },
		    { '@type': 'ListItem', position: 2, name: 'Blog', item: new URL('/blog/', Astro.site).toString() },
		    { '@type': 'ListItem', position: 3, name: title, item: new URL(Astro.url.pathname, Astro.site).toString() },
		  ],
		})} />
		<style>
				/* Align blog layout with site container to avoid right overflow and tight column */
				main {
					width: 1280px;
					max-width: calc(100% - 2em);
					margin: auto;
					background: var(--color-bg-primary);
				}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
				.prose {
					width: 100%;
					max-width: 870px;
					margin: auto;
					padding: 0.05em;
					color: var(--color-text-secondary);
					line-height: 1.8;
				}

				/* Markdown Styling */
				.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
					color: var(--color-text-primary);
					font-weight: 700;
					line-height: 1.3;
					margin-top: 2em;
					margin-bottom: 1em;
				}
				.prose h1 { font-size: 2.5em; }
				.prose h2 { font-size: 2em; border-bottom: 1px solid var(--color-border, #333); padding-bottom: 0.3em; }
				.prose h3 { font-size: 1.5em; }
				.prose h4 { font-size: 1.25em; }
				.prose h5 { font-size: 1.1em; }
				.prose h6 { font-size: 1em; }

				.prose p {
					margin: 1.5em 0;
					line-height: 1.8;
				}

				.prose a {
					color: #3498db;
					text-decoration: underline;
					transition: color 0.2s;
				}
				.prose a:hover {
					color: #2980b9;
				}

				.prose img {
					max-width: 100%;
					height: auto;
					border-radius: 8px;
					margin: 2em auto;
					display: block;
					box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				}

				.prose ul, .prose ol {
					margin: 1.5em 0;
					padding-left: 2em;
				}
				.prose li {
					margin: 0.5em 0;
				}
				.prose ul {
					list-style-type: disc;
				}
				.prose ol {
					list-style-type: decimal;
				}

				.prose blockquote {
					border-left: 4px solid #3498db;
					padding-left: 1.5em;
					margin: 2em 0;
					color: var(--color-text-muted);
					font-style: italic;
				}

				.prose code {
					background: rgba(110, 118, 129, 0.2);
					padding: 0.2em 0.4em;
					border-radius: 4px;
					font-size: 0.9em;
					font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
				}

				.prose pre {
					background: #1e1e1e;
					padding: 1.5em;
					border-radius: 8px;
					overflow-x: auto;
					margin: 2em 0;
				}
				.prose pre code {
					background: none;
					padding: 0;
					font-size: 0.9em;
					color: #d4d4d4;
				}

				.prose table {
					width: 100%;
					border-collapse: collapse;
					margin: 2em 0;
					overflow-x: auto;
					display: block;
				}
				.prose thead {
					background: rgba(52, 152, 219, 0.1);
				}
				.prose th {
					padding: 12px;
					text-align: left;
					font-weight: 600;
					border: 1px solid var(--color-border, #333);
					color: var(--color-text-primary);
				}
				.prose td {
					padding: 12px;
					border: 1px solid var(--color-border, #333);
				}
				.prose tbody tr:nth-child(even) {
					background: rgba(255, 255, 255, 0.02);
				}

				.prose hr {
					border: none;
					border-top: 2px solid var(--color-border, #333);
					margin: 3em 0;
				}

				.prose strong {
					font-weight: 700;
					color: var(--color-text-primary);
				}

				.prose em {
					font-style: italic;
				}

            .title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
                margin: 0 0 0.5em 0;
                color: var(--color-text-primary);
			}
			.date {
                margin-bottom: 0.5em;
                color: var(--color-text-muted);
			}
			.last-updated-on {
				font-style: italic;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
                {showHeader && (
                    <div class="hero-image">
                        {heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
                    </div>
                )}
                <div class="prose">
                    {showHeader && (
                        <div class="title">
                            <div class="date">
                                <FormattedDate date={pubDate} />
                                {
                                    updatedDate && (
                                        <div class="last-updated-on">
                                            Last updated on <FormattedDate date={updatedDate} />
                                        </div>
                                    )
                                }
                            </div>
                            <h1>{title}</h1>
                            <hr />
                        </div>
                    )}
                    <ShareButtons title={title} url={Astro.url.toString()} />
					<PostMeta pubDate={pubDate} readingTimeMin={readingTimeMin} authorName={Astro.props.author || 'Site Author'} />
                    <slot />
                    <PostNav prev={prevPost} next={nextPost} />
                </div>
			</article>
		</main>
		<Footer />
	</body>
</html>
